<div class="profile-container">
  <div class="profile-header">
    <h2>Mi Perfil</h2>
  </div>

  <div class="profile-content">
    <!-- Información del Perfil -->
    <p-card header="Información Personal" class="profile-card">
      <div class="profile-info">
        <!-- Avatar y Upload -->
        <div class="avatar-section">
          <div class="avatar-container">
            <div class="avatar-placeholder">
              <i class="pi pi-user avatar-icon"></i>
            </div>
            <div class="avatar-overlay" *ngIf="editMode">
              <p-fileUpload
                mode="basic"
                name="avatar"
                accept="image/*"
                [maxFileSize]="1000000"
                (onUpload)="onImageUpload($event)"
                [auto]="true"
                chooseLabel="Cambiar"
                class="avatar-upload">
              </p-fileUpload>
            </div>
          </div>
        </div>

        <!-- Formulario de Datos -->
        <div class="user-details">
          <form [formGroup]="profileForm" (ngSubmit)="saveProfile()">
            <div class="form-grid">
              <!-- Nombre -->
              <div class="form-field">
                <label for="firstName">Nombre *</label>
                <input 
                  id="firstName"
                  type="text"
                  pInputText
                  formControlName="firstName"
                  [readonly]="!editMode"
                  [class.p-invalid]="profileForm.get('firstName')?.invalid && profileForm.get('firstName')?.touched">
                <small class="p-error" *ngIf="getFieldError('firstName')">
                  {{ getFieldError('firstName') }}
                </small>
              </div>

              <!-- Apellido -->
              <div class="form-field">
                <label for="lastName">Apellido *</label>
                <input 
                  id="lastName"
                  type="text"
                  pInputText
                  formControlName="lastName"
                  [readonly]="!editMode"
                  [class.p-invalid]="profileForm.get('lastName')?.invalid && profileForm.get('lastName')?.touched">
                <small class="p-error" *ngIf="getFieldError('lastName')">
                  {{ getFieldError('lastName') }}
                </small>
              </div>

              <!-- Email -->
              <div class="form-field">
                <label for="email">Email *</label>
                <input 
                  id="email"
                  type="email"
                  pInputText
                  formControlName="email"
                  [readonly]="!editMode"
                  [class.p-invalid]="profileForm.get('email')?.invalid && profileForm.get('email')?.touched">
                <small class="p-error" *ngIf="getFieldError('email')">
                  {{ getFieldError('email') }}
                </small>
              </div>

              <!-- Username -->
              <div class="form-field">
                <label for="username">Usuario *</label>
                <input 
                  id="username"
                  type="text"
                  pInputText
                  formControlName="username"
                  [readonly]="!editMode"
                  [class.p-invalid]="profileForm.get('username')?.invalid && profileForm.get('username')?.touched">
                <small class="p-error" *ngIf="getFieldError('username')">
                  {{ getFieldError('username') }}
                </small>
              </div>

              <!-- Roles (Solo lectura) -->
              <div class="form-field">
                <label>Roles</label>
                <div class="roles-display">
                  <span 
                    *ngFor="let role of currentUser?.roles" 
                    class="role-tag">
                    {{ role }}
                  </span>
                </div>
              </div>

              <!-- Estado (Solo lectura) -->
              <div class="form-field">
                <label>Estado</label>
                <span [class]="currentUser?.active ? 'status-active' : 'status-inactive'">
                  {{ currentUser?.active ? 'Activo' : 'Inactivo' }}
                </span>
              </div>
            </div>

            <!-- Botones de Acción -->
            <div class="profile-actions">
              <div class="edit-actions" *ngIf="!editMode">
                <p-button 
                  label="Editar Perfil" 
                  icon="pi pi-pencil" 
                  (click)="toggleEditMode()">
                </p-button>
                <p-button 
                  label="Cambiar Contraseña" 
                  icon="pi pi-key" 
                  (click)="openPasswordDialog()"
                  severity="secondary">
                </p-button>
              </div>

              <div class="save-actions" *ngIf="editMode">
                <p-button 
                  label="Guardar" 
                  icon="pi pi-check" 
                  type="submit"
                  [loading]="loading"
                  [disabled]="profileForm.invalid">
                </p-button>
                <p-button 
                  label="Cancelar" 
                  icon="pi pi-times" 
                  (click)="toggleEditMode()"
                  severity="secondary">
                </p-button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </p-card>
  </div>
</div>

<!-- Dialog para Cambiar Contraseña -->
<p-dialog 
  [(visible)]="showPasswordDialog"
  header="Cambiar Contraseña"
  [modal]="true"
  [style]="{width:'400px'}"
  [closable]="true">
  
  <form [formGroup]="passwordForm" (ngSubmit)="changePassword()">
    <div class="password-form">
      <!-- Contraseña Actual -->
      <div class="form-field">
        <label for="currentPassword">Contraseña Actual *</label>
        <p-password
          id="currentPassword"
          formControlName="currentPassword"
          [feedback]="false"
          [toggleMask]="true"
          placeholder="Ingresa tu contraseña actual"
          [class.p-invalid]="passwordForm.get('currentPassword')?.invalid && passwordForm.get('currentPassword')?.touched">
        </p-password>
        <small class="p-error" *ngIf="getFieldError('currentPassword', passwordForm)">
          {{ getFieldError('currentPassword', passwordForm) }}
        </small>
      </div>

      <!-- Nueva Contraseña -->
      <div class="form-field">
        <label for="newPassword">Nueva Contraseña *</label>
        <p-password
          id="newPassword"
          formControlName="newPassword"
          [feedback]="true"
          [toggleMask]="true"
          placeholder="Mínimo 6 caracteres"
          [class.p-invalid]="passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched">
        </p-password>
        <small class="p-error" *ngIf="getFieldError('newPassword', passwordForm)">
          {{ getFieldError('newPassword', passwordForm) }}
        </small>
      </div>

      <!-- Confirmar Contraseña -->
      <div class="form-field">
        <label for="confirmPassword">Confirmar Contraseña *</label>
        <p-password
          id="confirmPassword"
          formControlName="confirmPassword"
          [feedback]="false"
          [toggleMask]="true"
          placeholder="Repite la nueva contraseña"
          [class.p-invalid]="passwordForm.get('confirmPassword')?.invalid && passwordForm.get('confirmPassword')?.touched">
        </p-password>
        <small class="p-error" *ngIf="getFieldError('confirmPassword', passwordForm)">
          {{ getFieldError('confirmPassword', passwordForm) }}
        </small>
      </div>
    </div>

    <!-- Footer del Dialog -->
    <ng-template pTemplate="footer">
      <p-button 
        label="Cancelar" 
        icon="pi pi-times" 
        (click)="closePasswordDialog()"
        severity="secondary">
      </p-button>
      <p-button 
        label="Cambiar Contraseña" 
        icon="pi pi-check" 
        type="submit"
        [loading]="loading"
        [disabled]="passwordForm.invalid">
      </p-button>
    </ng-template>
  </form>
</p-dialog>

<!-- Toast Messages -->
<p-toast></p-toast>
